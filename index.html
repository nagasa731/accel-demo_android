<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>加速度検知テスト v3 (Android対応版)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; color: #333; transition: background-color 0.1s ease; }
        h1 { font-size: 1.5rem; }
        p { font-size: 1rem; }
        #permissionButton { font-size: 1.2rem; padding: 15px 30px; cursor: pointer; border-radius: 10px; border: none; background-color: #007aff; color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        #status { font-size: 0.9rem; color: #555; margin-top: 20px; min-height: 1.2em; }
        #data { font-size: 1.8rem; font-weight: bold; color: #000; margin-top: 10px; min-height: 1.5em; }
        #result { font-size: 3rem; font-weight: 800; color: #d90000; min-height: 1.5em; margin-top: 10px; }
        body.detected { background-color: #ffcccc; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 30px 10px; }
        h2 { font-size: 1.2rem; }
        .setting-container { margin: 20px 0; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #thresholdSlider { width: 70%; margin: 10px 0; }
        #thresholdValue { font-weight: bold; font-size: 1.1rem; color: #007aff; display: inline-block; width: 40px; }
        h3 { font-size: 1.1rem; }
        #logList { list-style-type: none; padding: 0; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background-color: #fff; border-radius: 8px; text-align: left; }
        #logList li { padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        #logList li:nth-child(odd) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <h1>スマホ加速度検知 v3</h1>
    <p>「開始」ボタンを押して、スマホを上に素早く振ってください。</p>

    <button id="permissionButton">検知を開始</button>

    <div id="status">許可待ち...</div>
    <div id="data">Y加速度: 0.00</div>
    <div id="result"></div>

    <hr>
    
    <h2>設定とログ</h2>

    <div class="setting-container">
        <label for="thresholdSlider">検知しきい値 (振りの強さ): </label>
        <input type="range" id="thresholdSlider" min="5" max="40" step="1" value="15">
        <span id="thresholdValue">15.0</span>
    </div>

    <h3>検知ログ (最新が上)</h3>
    <ul id="logList">
        </ul>

    <script>
        // DOM要素を取得 (v2と同じ)
        const permissionButton = document.getElementById('permissionButton');
        const statusDiv = document.getElementById('status');
        const dataDiv = document.getElementById('data');
        const resultDiv = document.getElementById('result');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValueSpan = document.getElementById('thresholdValue');
        const logList = document.getElementById('logList');

        // 検知のしきい値 (振りの強さ)
        let THRESHOLD = parseFloat(thresholdSlider.value);
        let isDetecting = false;
        
        // ▼▼▼ Android対応のための追加変数 ▼▼▼
        // 重力加速度 (約9.8) を推定するための変数
        let gravityY = 0;
        // ローパスフィルタの係数 (0に近いほどゆっくり変化)
        const ALPHA = 0.8; 
        
        // 重力込み(G)か、重力抜き(A)のどちらのモードで動作しているか
        let sensorMode = 'Unknown'; 
        // ▲▲▲

        // スライダーが操作されたら、しきい値(THRESHOLD)を更新
        thresholdSlider.addEventListener('input', () => {
            THRESHOLD = parseFloat(thresholdSlider.value);
            thresholdValueSpan.textContent = THRESHOLD.toFixed(1);
        });

        // 1. 許可ボタンのクリックイベント (v2と同じ)
        permissionButton.addEventListener('click', () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startMotionDetection();
                        } else {
                            statusDiv.textContent = '加速度センサーの使用が許可されませんでした。';
                        }
                    })
                    .catch(error => {
                        statusDiv.textContent = '許可エラー: ' + error.message;
                    });
            } else {
                startMotionDetection();
            }
        });

        // 2. 加速度センサーの監視を開始する関数 (v2と同じ)
        function startMotionDetection() {
            permissionButton.style.display = 'none';
            statusDiv.textContent = '監視中... スマホを上に振ってください';
            window.addEventListener('devicemotion', handleMotionEvent);
        }

        // 3. 'devicemotion' イベントを処理する関数 (▼▼▼ ここを大きく修正 ▼▼▼)
        function handleMotionEvent(event) {
            
            let y_accel_raw = 0; // センサーから取得した生のY軸加速度
            let y_accel = 0;     // 計算後の「振りの強さ」

            // --- センサーデータの取得とモード判定 ---
            
            // (A) iPhoneパターン: event.acceleration (重力除く) が利用可能な場合
            if (event.acceleration && typeof event.acceleration.y === 'number') {
                
                if (sensorMode === 'Unknown') sensorMode = 'A (重力除く)';
                
                y_accel_raw = event.acceleration.y;
                y_accel = y_accel_raw; // 重力除くデータなので、そのまま「振りの強さ」として使う
            
            // (B) Androidパターン: event.accelerationIncludingGravity (重力込み) しか使えない場合
            } else if (event.accelerationIncludingGravity && typeof event.accelerationIncludingGravity.y === 'number') {
                
                if (sensorMode === 'Unknown') sensorMode = 'G (重力込み)';

                y_accel_raw = event.accelerationIncludingGravity.y;
                
                // --- ローパスフィルタで重力成分を推定 ---
                // y_accel_raw (重力 + 振りの強さ) のうち、ゆっくり動く成分(gravityY)を計算
                gravityY = ALPHA * gravityY + (1 - ALPHA) * y_accel_raw;
                
                // 「振りの強さ」 = 「全体の加速度」 - 「重力成分」
                y_accel = y_accel_raw - gravityY;

            } else {
                // どちらも取れない場合
                statusDiv.textContent = '加速度センサーのデータを取得できません。';
                return;
            }

            // --- データ表示 ---
            // 画面には、計算後の「振りの強さ」を表示
            dataDiv.textContent = `Y加速度 (振りの強さ): ${y_accel.toFixed(2)}`;
            
            // ステータス欄に、動作モードを表示 (初回のみ)
            if (statusDiv.textContent === '監視中... スマホを上に振ってください') {
                statusDiv.textContent = `監視中 (モード: ${sensorMode})`;
            }

            // --- 検知判定 ---
            // 計算後の「振りの強さ」(y_accel) が スライダーのしきい値(THRESHOLD) を超えたか
            if (y_accel > THRESHOLD && !isDetecting) {
                
                isDetecting = true;
                resultDiv.textContent = '検知！';
                document.body.classList.add('detected');

                // --- ログ追加処理 ---
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                const logEntry = document.createElement('li');
                // ログには「振りの強さ」と「生のY軸の値」を両方記録
                logEntry.textContent = `[${timeString}] 検知: ${y_accel.toFixed(2)} (Raw: ${y_accel_raw.toFixed(2)}, Mode: ${sensorMode})`;
                
                logList.prepend(logEntry);
                // ---

                console.log(`検知: ${y_accel.toFixed(2)} m/s^2`);

                // 1秒後に表示をリセット
                setTimeout(() => {
                    resultDiv.textContent = '';
                    document.body.classList.remove('detected');
                    isDetecting = false;
                }, 1000);
            }
        }
    </script>

</body>
</html>
